<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>03 - Writing Smart Contracts in Solidity - Web3 Teacher Training Track</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://web3.courses/favicon.ico">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">


  
  
  <link rel="stylesheet" href="/css/style.min.7e6b66ff40df185a246ccc551f493c0ccc1248be6a309fe768442cb166b59bf8.css">
  

  
  
    <link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css"
  integrity="sha256-hFAmQt2dGk6G99nu2cEWz8/1JGRnBP/BsGoZwQ7WeLE="
  crossorigin="anonymous"
/>

  


</head>

<body class='page page-default-single'>
  <header class="header">
  <div class="header__logo">
    <a href="https://web3.courses/"><img alt="Logo" src="/images/icon.png" /></a>
  </div>
  <ul id="main-menu" class="main-menu">
  
  
  <li class="main-menu__item menu-item-home">
    <a class="main-menu__link" href="/">Home</a>
  </li>
  
  <li class="main-menu__item menu-item-course">
    <a class="main-menu__link" href="/teacher-training-track">Course</a>
  </li>
  
  <li class="main-menu__item menu-item-apply">
    <a class="main-menu__link" href="/apply"target="_blank">Apply</a>
  </li>
  
</ul>

</header>


  
  
    
      
    
  

  <div class="center-wrapper">
    <div class="wrapper">
      
        
<aside class="sidebar">
  <h4 class="sidebar__header">Teacher Training Track</h4>
  <ul class="sidebar__list">
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/syllabus/">Syllabus</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/calendar/">Calendar</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/useful-information/">Useful Information</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/lesson-plan/">Lesson Plan</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/01-intro-blockchain-smart-contracts/">01 - Intro to Blockchain &amp; Smart Contracts</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/02-exploring-smart-contracts/">02 - Exploring Smart Contracts</a>
    </li>
    
    <li class="sidebar__item sidebar__item--active">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/03-writing-smart-contracts-solidity/">03 - Writing Smart Contracts in Solidity</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/04-working-with-local-blockchain/">04 - Working with a Local Blockchain</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/05-connecting-to-web-apps/">05 - Connecting to Web Apps</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/06-deploying-to-testnet/">06 - Deploying to Testnet</a>
    </li>
    
    <li class="sidebar__item">
      <a class="sidebar__link" href="https://web3.courses/teacher-training-track/07-next-steps/">07 - Next Steps</a>
    </li>
    
  </ul>
  
    <h4 class="sidebar__header">Outline</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#essential-syntax">Essential Syntax</a>
      <ul>
        <li><a href="#listing">Listing</a></li>
        <li><a href="#concepts">Concepts</a></li>
        <li><a href="#exercises">Exercises</a></li>
      </ul>
    </li>
    <li><a href="#payable-functions">Payable Functions</a>
      <ul>
        <li><a href="#listing-1">Listing</a></li>
        <li><a href="#concepts-1">Concepts</a></li>
        <li><a href="#exercises-1">Exercises</a></li>
      </ul>
    </li>
    <li><a href="#design-patterns--security-considerations">Design Patterns &amp; Security Considerations</a>
      <ul>
        <li><a href="#listing-2">Listing</a></li>
        <li><a href="#concepts-2">Concepts</a></li>
        <li><a href="#exercises-2">Exercises</a></li>
      </ul>
    </li>
    <li><a href="#project-status-update">Project Status Update</a></li>
  </ul>
</nav>
  
  
  
  
  
    <h4 class="sidebar__header">Lesson Material</h4>
    <ul class="sidebar__list">
      
      <li class="sidebar__item">
        <a class="sidebar__link" target="_blank" href="/teacher-training-track/03-writing-smart-contracts-solidity/slides.html">Slides</a>
      </li>
      
      
        
          <li class="sidebar__item">
            <a class="sidebar__link" target="_blank" href="https://www.youtube.com/watch?v=K82Jp8zq9f4">Recording</a>
          </li>
        
      
    </ul>
  
</aside>

      

      <main class="content">
        
  <h1 class="title">03 - Writing Smart Contracts in Solidity</h1>
  
  <ul class="tags">
    
      
      <li class="tags__item"><a class="tags__link" href="https://web3.courses/tags/gas/">gas</a></li>
    
      
      <li class="tags__item"><a class="tags__link" href="https://web3.courses/tags/gwei/">gwei</a></li>
    
      
      <li class="tags__item"><a class="tags__link" href="https://web3.courses/tags/remix/">remix</a></li>
    
      
      <li class="tags__item"><a class="tags__link" href="https://web3.courses/tags/smart-contract/">smart contract</a></li>
    
      
      <li class="tags__item"><a class="tags__link" href="https://web3.courses/tags/solidity/">solidity</a></li>
    
      
      <li class="tags__item"><a class="tags__link" href="https://web3.courses/tags/wei/">wei</a></li>
    
  </ul>
  
  <div class="content ">
    <p>Follow along in <a href="https://remix.ethereum.org/">Remix IDE</a>. Copy and paste the listings, deploy and test your solutions to the exercises.</p>
<h2 id="essential-syntax">Essential Syntax</h2>
<h3 id="listing">Listing</h3>
<p><a href="https://github.com/bafnetwork/web3ttt/blob/main/examples/03/01_FreeToken.sol">View on GitHub</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="c1">// SPDX-License-Identifier: &lt;license-identifier-here&gt;
</span><span class="c1">// ex. SPDX-License-Identifier: MIT
</span><span class="c1">// ex. SPDX-License-Identifier: GPL-3.0-or-later
</span><span class="c1">// ex. SPDX-License-Identifier: UNLICENSED
</span><span class="c1"></span>
<span class="c1">// Solidity compiler version
</span><span class="c1">// You can specify more precise version selection bounds by using the syntax
</span><span class="c1">// here: https://docs.npmjs.com/cli/v6/using-npm/semver
</span><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">4</span><span class="p">;</span>

<span class="c1">// Most of your code will live inside a contract declaration
</span><span class="c1"></span><span class="kd">contract</span> <span class="nc">FreeToken</span> <span class="p">{</span>
    <span class="c1">// Solidity has a few unique data types, such as mapping, address
</span><span class="c1"></span>    <span class="c1">// A mapping is like an associative array, dictionary, or hashmap
</span><span class="c1"></span>    <span class="c1">// This mapping maps Ethereum addresses to 256-bit unsigned integers
</span><span class="c1"></span>    <span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">balances</span><span class="p">;</span>

    <span class="c1">// The public access modifier doesn&#39;t allow external code to write to this
</span><span class="c1"></span>    <span class="c1">// value, only read
</span><span class="c1"></span>    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">totalSupply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// External functions can only be called from OUTSIDE the contract, and are
</span><span class="c1"></span>    <span class="c1">// disallowed from making internal function calls. Public functions can do
</span><span class="c1"></span>    <span class="c1">// both, but are more expensive.
</span><span class="c1"></span>    <span class="c1">// This function doesn&#39;t modify the state of the contract, so it is marked
</span><span class="c1"></span>    <span class="c1">// with the view modifier
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nf">balanceOf</span> <span class="p">(</span><span class="kt">address</span> <span class="n">_wallet</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">balances</span><span class="p">[</span><span class="n">_wallet</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// This function does modify the state of the contract, so no view modifier
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nf">mint</span> <span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
        <span class="c1">// msg.sender gives us the external address that initiated this call
</span><span class="c1"></span>        <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">totalSupply</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Could this function be improved?
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nf">transfer</span> <span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="c1">// Failed calls to require() revert the transaction, undoing state
</span><span class="c1"></span>        <span class="c1">// changes
</span><span class="c1"></span>        <span class="nb">require</span><span class="p">(</span><span class="n">_amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Amount must be nonzero&#34;</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_amount</span><span class="p">,</span> <span class="s">&#34;Insufficient balance&#34;</span><span class="p">);</span>

        <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_amount</span><span class="p">;</span>
        <span class="n">balances</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="concepts">Concepts</h3>
<p>Executing code on the blockchain costs money, and it&rsquo;s paid for in Ethereum. The network defines a unit called <strong>gas</strong>, which is set to some amount of ETH. Executing code on the Ethereum network takes some amount of gas. For example, a regular old ETH transfer transaction takes 21,000 gas. The more complex a contract&rsquo;s logic, the more gas it will take, and therefore, the more expensive it will be to call that contract.</p>
<p>Some general rules to keep your gas usage low:</p>
<ul>
<li>Only compute what you absolutely have to</li>
<li>Storage I/O is <em>expensive</em>, memory less so</li>
<li>Be <em>very careful</em> when writing looping or recursive logic</li>
</ul>
<p>Some recent values for example:</p>
<p>Gas price: 66 Gwei (0.000000066 ETH)<br>
Gas for transaction: 21,000<br>
Transaction fee: 21,000 Ã— 0.000000066 ETH = 0.001386 ETH (<!-- raw HTML omitted -->$<!-- raw HTML omitted -->3.82 @ <!-- raw HTML omitted -->$<!-- raw HTML omitted -->2,756.35/ETH)</p>
<h3 id="exercises">Exercises</h3>
<ol>
<li>Create a <code>gift(address, uint256)</code> function that adds an amount to anyone&rsquo;s balance, and rewards the gifter with a call to the <code>mint()</code> function
<ul>
<li>Make sure to update <code>totalSupply</code>.</li>
<li>What modifiers should the function have?</li>
</ul>
</li>
<li>The transfer function could use less gas while having the same functionality. What improvements can you make?
<ul>
<li>Implementing these two optimizations improved the execution cost of the function from 28847 gas to 12777 gas (55.7% improvement).</li>
<li>Optimization 1:
<ul>
<li>Involves reading from storage</li>
<li><a href="https://docs.soliditylang.org/en/v0.8.4/introduction-to-smart-contracts.html#storage-memory-and-the-stack">Hint 1</a></li>
</ul>
</li>
<li>Optimization 2:
<ul>
<li>Involves integer overflow safeguards</li>
<li><a href="https://docs.soliditylang.org/en/v0.8.4/080-breaking-changes.html#silent-changes-of-the-semantics">Hint 1</a></li>
<li><a href="https://docs.soliditylang.org/en/v0.8.4/control-structures.html#checked-or-unchecked-arithmetic">Hint 2</a></li>
</ul>
</li>
<li>If you need help, check out <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5f50b9f6e02c6a8ce8fc4b243fdbbf210b0e6446/contracts/token/ERC20/ERC20.sol#L215">this transfer function from an OpenZeppelin ERC-20 implementation</a>.</li>
</ul>
</li>
</ol>
<h2 id="payable-functions">Payable Functions</h2>
<h3 id="listing-1">Listing</h3>
<p><a href="https://github.com/bafnetwork/web3ttt/blob/main/examples/03/02_VeryExpensiveToken.sol">View on GitHub</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">4</span><span class="p">;</span>

<span class="kd">contract</span> <span class="nc">VeryExpensiveToken</span> <span class="p">{</span>
    <span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">public</span> <span class="n">balances</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">totalSupply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// ETH can be sent to payable addresses
</span><span class="c1"></span>    <span class="kt">address</span> <span class="k">payable</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>

    <span class="c1">// Called when the contract is first deployed
</span><span class="c1"></span>    <span class="kd">constructor</span> <span class="p">(</span><span class="kt">address</span> <span class="k">payable</span> <span class="n">_owner</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">_owner</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Events appear in logs (e.g. for debugging) and web3 applications can
</span><span class="c1"></span>    <span class="c1">// listen for them
</span><span class="c1"></span>    <span class="c1">// Indexed parameters are searchable in logs
</span><span class="c1"></span>    <span class="kd">event</span> <span class="nc">BuyEvent</span><span class="p">(</span><span class="kt">address</span> <span class="k">indexed</span> <span class="n">buyer</span><span class="p">,</span> <span class="kt">uint256</span> <span class="k">indexed</span> <span class="n">tokenIndex</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">price</span><span class="p">);</span>

    <span class="c1">// Functions marked payable have access to msg.value, which is a quantity of
</span><span class="c1"></span>    <span class="c1">// ETH tokens sent along with the function call
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nf">buy</span> <span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">_totalSupply</span> <span class="o">=</span> <span class="n">totalSupply</span><span class="p">;</span>
        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;=</span> <span class="n">_nextTokenCost</span><span class="p">(</span><span class="n">_totalSupply</span><span class="p">),</span>
            <span class="s">&#34;Not enough to buy next token&#34;</span><span class="p">);</span>
        <span class="n">totalSupply</span> <span class="o">=</span> <span class="n">_totalSupply</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

        <span class="c1">// Emits an event
</span><span class="c1"></span>        <span class="n">emit</span> <span class="n">BuyEvent</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_totalSupply</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">nextTokenCost</span> <span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_nextTokenCost</span><span class="p">(</span><span class="n">totalSupply</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Pure functions cannot modify state, like view functions, but it also
</span><span class="c1"></span>    <span class="c1">// cannot read state either
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nf">_nextTokenCost</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">_totalSupply</span><span class="p">)</span> <span class="k">public</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// There are some nice keywords for pecuniary numbers in Solidity:
</span><span class="c1"></span>        <span class="c1">//   1 wei == 1
</span><span class="c1"></span>        <span class="c1">//   1 gwei == 1e9
</span><span class="c1"></span>        <span class="c1">//   1 ether == 1e18
</span><span class="c1"></span>        <span class="c1">// Also for durations:
</span><span class="c1"></span>        <span class="c1">//   1 seconds == 1
</span><span class="c1"></span>        <span class="c1">//   minutes, hours, days, weeks
</span><span class="c1"></span>        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">_totalSupply</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">withdraw</span> <span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
        <span class="nb">assert</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">owner</span><span class="p">);</span>

        <span class="c1">// Although .send() and .transfer() functions exist for sending ETH,
</span><span class="c1"></span>        <span class="c1">// their use is no longer recommended because they rely on a constant
</span><span class="c1"></span>        <span class="c1">// gas cost for computations which is no longer a safe assumption
</span><span class="c1"></span>        <span class="c1">// https://consensys.net/diligence/blog/2019/09/stop-using-soliditys-transfer-now
</span><span class="c1"></span>        <span class="c1">// !!!WARNING!!!
</span><span class="c1"></span>        <span class="c1">// There is potential for even worse bugs or vulnerabilities if this
</span><span class="c1"></span>        <span class="c1">// method is not used carefully. Proper usage is covered in the next
</span><span class="c1"></span>        <span class="c1">// section.
</span><span class="c1"></span>        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span> <span class="nb">value</span><span class="o">:</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span> <span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Withdraw failed&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">balanceOf</span> <span class="p">(</span><span class="kt">address</span> <span class="n">_wallet</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">balances</span><span class="p">[</span><span class="n">_wallet</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">transfer</span> <span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="concepts-1">Concepts</h3>
<p>Payable functions are able to receive ETH tokens. The payment value is in the <code>msg.value</code> global in units of <strong>wei</strong>, the smallest division of Ethereum (1 ether = $10^{18}$ wei).</p>
<p>If you are short on gas and your logic can be performed off-chain somewhere, <strong>events</strong> are a relatively cheap (although not free) way to integrate off-chain logic into an application. Web3 applications can listen for events and react to them.</p>
<h3 id="exercises-1">Exercises</h3>
<ol>
<li>Create a <code>buyOut()</code> function which changes the owner to <code>msg.sender</code> if <code>(2 ** (2 + totalSupply)) * 1 ether</code> tokens are attached.
<ul>
<li>Implement the buyout value as a pure function.</li>
<li>Make sure to handle payouts to the old owner correctly!</li>
<li>Emit a (new) <code>BuyOutEvent</code> with the old and new owner indexed, and the buyout price.</li>
<li><code>address(this).balance</code> is increased by <code>msg.value</code> before execution begins.</li>
</ul>
</li>
<li>Read <a href="https://docs.soliditylang.org/en/v0.8.4/common-patterns.html#withdrawal-from-contracts">this section in the Solidity documentation</a>. Rewrite <code>buyOut()</code> with these considerations.</li>
</ol>
<h2 id="design-patterns--security-considerations">Design Patterns &amp; Security Considerations</h2>
<h3 id="listing-2">Listing</h3>
<p><a href="https://github.com/bafnetwork/web3ttt/blob/main/examples/03/03_InconspicuousToken.sol">View on GitHub</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">4</span><span class="p">;</span>

<span class="kd">contract</span> <span class="nc">InconspicuousToken</span> <span class="p">{</span>
    <span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="n">balances</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">totalSupply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Constant values are defined at compile time and replaced throughout the
</span><span class="c1"></span>    <span class="c1">// contract so they do not incur a storage read cost.
</span><span class="c1"></span>    <span class="kt">uint256</span> <span class="k">constant</span> <span class="n">minimumBuy</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">gwei</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">balanceOf</span> <span class="p">(</span><span class="kt">address</span> <span class="n">_wallet</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">balances</span><span class="p">[</span><span class="n">_wallet</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// Errors look a little bit like events, but they halt execution when used
</span><span class="c1"></span>    <span class="n">error</span> <span class="n">InsufficientBuy</span><span class="p">();</span>

    <span class="c1">// Custom function modifiers alter function behavior
</span><span class="c1"></span>    <span class="kd">modifier</span> <span class="nf">enforceMinimumBuy</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Similar to a require(...) call
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&lt;</span> <span class="n">minimumBuy</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">revert</span> <span class="n">InsufficientBuy</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// Will be replaced with the modified function&#39;s body
</span><span class="c1"></span>        <span class="k">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">contractBalance</span> <span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Uses a custom function modifier to ensure that a condition is met
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nf">buy</span> <span class="p">()</span> <span class="k">payable</span> <span class="k">external</span> <span class="n">enforceMinimumBuy</span> <span class="p">{</span>
        <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
        <span class="n">totalSupply</span> <span class="o">+=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">sell</span> <span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
        <span class="c1">// !!!WARNING!!!
</span><span class="c1"></span>        <span class="c1">// This function is vulnerable!
</span><span class="c1"></span>
        <span class="c1">// Send the user their unwrapped funds
</span><span class="c1"></span>        <span class="kt">uint256</span> <span class="nb">balance</span> <span class="o">=</span> <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">];</span>
        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="k">payable</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">).</span><span class="nb">call</span><span class="p">{</span>
            <span class="nb">value</span><span class="o">:</span> <span class="nb">balance</span>
        <span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>

        <span class="c1">// Don&#39;t empty their wallet if the transaction failed
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">totalSupply</span> <span class="o">-=</span> <span class="nb">balance</span><span class="p">;</span>
            <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">transfer</span> <span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="concepts-2">Concepts</h3>
<h4 id="fallback--receive-functions">Fallback &amp; Receive Functions</h4>
<p>Recall that any given Ethereum address may be controlled by a smart contract or a real person. Smart contracts can also respond to transactions sent directly to their address by using a special <code>fallback</code> or <code>receive</code> function. These functions look like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="c1">// No function keyword
</span><span class="c1"></span><span class="n">receive</span> <span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
    <span class="c1">// Called when the contract address is paid directly
</span><span class="c1"></span>    <span class="c1">// Just like any other payable function
</span><span class="c1"></span>    <span class="c1">// Keep in mind the gas limit could be as low as 2300
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// Optionally payable
</span><span class="c1"></span><span class="n">fallback</span> <span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
    <span class="c1">// Called when no function signature matches
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>See the documentation for <a href="https://docs.soliditylang.org/en/v0.8.4/contracts.html#fallback-function">fallback functions</a> and <a href="https://docs.soliditylang.org/en/v0.8.4/contracts.html#receive-ether-function">receive functions</a>.</p>
<h4 id="cross-contract-calls">Cross-contract calls</h4>
<p>Smart contracts can call each other if they know the address and interface of the contract they want to call. Fortunately, addresses aren&rsquo;t too difficult to discover, and a contract&rsquo;s interface can be easily imported into another file by using the <code>import</code> keyword:</p>
<div class="highlight"><pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="c1">// At the top of the file
</span><span class="c1"></span><span class="kn">import</span> <span class="s">&#34;./InconspicuousToken.sol&#34;</span><span class="p">;</span>

<span class="c1">// Elsewhere in your contract...
</span><span class="c1"></span><span class="n">InconspicuousToken</span> <span class="n">it</span> <span class="o">=</span> <span class="n">InconspicuousToken</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">);</span>
<span class="n">it</span><span class="p">.</span><span class="n">buy</span><span class="p">{</span> <span class="nb">value</span><span class="o">:</span> <span class="cm">/* ... */</span> <span class="p">}();</span>
<span class="n">it</span><span class="p">.</span><span class="n">sell</span><span class="p">();</span>
</code></pre></div><p>See <a href="https://docs.soliditylang.org/en/v0.8.4/layout-of-source-files.html#importing-other-source-files">the documentation for import</a> and <a href="https://ethereum.org/en/developers/tutorials/interact-with-other-contracts-from-solidity/">more information about calling other contracts</a>.</p>
<h4 id="security-vulnerability-re-entrancy">Security Vulnerability: Re-entrancy</h4>
<p>Sending ETH to an address has the potential to trigger some smart contract code&mdash;smart contract code which could theoretically call other smart contract code and so on and so forth.</p>
<p>This all brings us to a type of security vulnerability called <strong>re-entrancy</strong>, and as it turns out, the above listing is vulnerable to a re-entrancy attack.</p>
<p>The general idea of a re-entrancy attack is to call back into a contract while it is in the middle of executing (i.e. when it calls another contract), in order to take advantage of an invalid intermediate state.</p>
<h4 id="mitigation">Mitigation</h4>
<p>Use the <strong>checks-effects-interactions</strong><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> order of operations:</p>
<ol>
<li>Check &amp; validate your input</li>
<li>Perform any and all modifications to contract state</li>
<li>Send calls to other contracts</li>
</ol>
<p>This ensures that your contract state will <em>always</em> be valid when other contracts may be attempting to interact with it <em>even as part of one of your own function calls</em>.</p>
<h3 id="exercises-2">Exercises</h3>
<ol>
<li>Construct a contract that performs a re-entrancy attack on <code>InconspicuousToken</code>.
<ul>
<li>Your contract should contain four functions:
<ul>
<li><code>contractBalance()</code> for figuring out if your attack worked</li>
<li>A <code>receive</code> function</li>
<li><code>performAttack1(address)</code> which performs a buy on <code>InconspicuousToken</code></li>
<li><code>performAttack2(address)</code> which performs a sell on <code>InconspicuousToken</code></li>
</ul>
</li>
<li>The attack should drain the <code>InconspicuousToken</code>&rsquo;s balance into the attacking contract&rsquo;s balance</li>
</ul>
</li>
<li>Use the check-effects-interactions pattern to fix <code>InconspicuousToken</code>.</li>
</ol>
<h2 id="project-status-update">Project Status Update</h2>
<p>Begin writing the smart contract(s) for your project. Do not be afraid to use sources like <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts">the OpenZeppelin contract library</a> for help and inspiration. Remember to emit events for things that your web application will need to be aware of!</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://docs.soliditylang.org/en/v0.8.4/security-considerations.html#use-the-checks-effects-interactions-pattern">https://docs.soliditylang.org/en/v0.8.4/security-considerations.html#use-the-checks-effects-interactions-pattern</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

  </div>

      </main>
    </div>
  </div>

  

  
  
    <script
  src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"
  integrity="sha256-+EWBEj6A8lxFvckkChitv8/RcHK/PcWvQV+D7PDflC8="
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"
  integrity="sha256-G53bYZLObbTLTA3j70xRGPKxKYlBbzvDZ789B6sSFkE="
  crossorigin="anonymous"
></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    renderMathInElement(document.body, {
      
      
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true },
      ],
      
      throwOnError: false,
    });
  });
</script>

  


  
  <script type="text/javascript" src="/js/scripts.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script>
  

  
  
  
    
  


</body>

</html>
